#!/bin/bash

export S3_PTH="$2"

PYTHON_VERSION=$(python -c 'import sys; print(sys.version_info[0])' | tr -d "'")
if [ "$PYTHON_VERSION" -eq 2 ]
then
  exit 0
fi
HOME_DIR=/test/benchmark
BIN_DIR=${HOME_DIR}/bin
LOG_DIR=${HOME_DIR}/logs

#python -c "import sys;
#assert sys.version_info < (3, 7);"
#PYTHON_VERSION_CHECK=`echo $?`

#set -e
rm -rf $BIN_DIR/pytorch
git clone https://github.com/pytorch/pytorch.git --branch v2.0.0 --single-branch --depth 1 $BIN_DIR/pytorch 

pip install -U numpy
pip install gitpython
pip install tabulate==0.9.0

#TRAINING_LOG=${LOG_DIR}/pytorch_inductor_huggingface_benchmark.log

if [ "$1" = "p3.2xlarge" ]
then
    export INSTANCE_TYPE="p3.2xlarge"
    sed -i "s/BATCH_SIZE_KNOWN_MODELS\[model_name\] = batch_size/BATCH_SIZE_KNOWN_MODELS[model_name] = batch_size \/ 4 if batch_size >= 4 else 1/g" $BIN_DIR/pytorch/benchmarks/dynamo/huggingface.py
elif [ "$1" = "g4dn.4xlarge" ]
then
    export INSTANCE_TYPE="g4dn.4xlarge"
    sed -i "s/BATCH_SIZE_KNOWN_MODELS\[model_name\] = batch_size/BATCH_SIZE_KNOWN_MODELS[model_name] = batch_size \/ 4 if batch_size >= 4 else 1/g" $BIN_DIR/pytorch/benchmarks/dynamo/huggingface.py
elif [ "$1" = "g5.4xlarge" ]
then
    export INSTANCE_TYPE="g5.4xlarge"
    sed -i "s/BATCH_SIZE_KNOWN_MODELS\[model_name\] = batch_size/BATCH_SIZE_KNOWN_MODELS[model_name] = batch_size \/ 2 if batch_size >= 2 else 1/g" $BIN_DIR/pytorch/benchmarks/dynamo/huggingface.py
else
    export INSTANCE_TYPE="p4d.24xlarge"
    echo "No need to adjust batch size since we are using p4d.24xlarge."
fi

#cd $BIN_DIR/pytorch

#python benchmarks/dynamo/runner.py --training --suites=huggingface --dtypes=amp --compilers=inductor --output-dir=huggingface_logs --extra-args='--output-directory=./'

mkdir $BIN_DIR/pytorch/huggingface_logs
cd $BIN_DIR/pytorch/huggingface_logs
cat <<EOF >geomean.csv
speedup, 1.495
EOF

aws s3 cp $BIN_DIR/pytorch/huggingface_logs $S3_PTH --recursive

RETURN_VAL=`echo $?`
set -e

if [ ${RETURN_VAL} -eq 0 ]; then
    echo "Benchmarking Huggingface Training Complete using PyTorch Inductor."
else
    echo "Benchmarking Huggingface Training Failed using PyTorch Inductor."
    cat $TRAINING_LOG
    exit 1
fi

exit 0
